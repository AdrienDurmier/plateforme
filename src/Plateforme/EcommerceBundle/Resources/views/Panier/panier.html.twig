{% extends "PlateformeCoreBundle::frontoffice.html.twig" %}

{% set totalHT = 0 %}
{% set totalTTC = 0%}
{% set totalTVAs = {} %}
{% for produit in produits %}
  {% set totalTVAs = totalTVAs|merge({ (produit.tva.valeur ~ '%') : 0 }) %}
{% endfor %}

{% block title %}
  Panier - {{ parent() }}
{% endblock %}

{% block body %}
  <div class="container">

    {% if produits|length > 0 %}
      <div class="hidden-small">
        <div class="row">
          <div class="col-2 text-center text-primary">
            <small>Votre panier</small>
            <br><i class="fa fa-shopping-cart" aria-hidden="true"></i>
          </div>
          <div class="col-2 text-center text-muted">
            <small>Authentification</small>
            <br><i class="fa fa-sign-in" aria-hidden="true"></i>
          </div>
          <div class="col-2 text-center text-muted">
            <small>Livraison</small>
            <br><i class="fa fa-truck" aria-hidden="true"></i>
          </div>
          <div class="col-2 text-center text-muted">
            <small>Validation</small>
            <br><i class="fa fa-check-square" aria-hidden="true"></i>
          </div>
          <div class="col-2 text-center text-muted">
            <small>Paiement</small>
            <br><i class="fa fa-money" aria-hidden="true"></i>
          </div>
          <div class="col-2 text-center text-muted">
            <small>Récapitulatif</small>
            <br><i class="fa fa-thumbs-o-up" aria-hidden="true"></i>
          </div>
        </div>
        <div class="progress" style="height: 1px;">
          <div class="progress-bar" role="progressbar" style="width: 17%" aria-valuenow="17" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <br>
      </div>
    {% endif %}

    <h1>Votre panier</h1>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Référence</th>
          <th>Prix unitaire</th>
          <th>Quantité</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% if produits|length == 0 %}
          <tr>
            <td colspan="5"><center>Aucun articles dans votre panier</center></td>
        </tr>
      {% endif %}

      {% for produit in produits %}
        <tr>
        <form action="{{ path('plateforme_ecommerce_commandeligne_add', { 'id' : produit.id }) }}" method="get">
          <td>
            <a href="{{ path('plateforme_core_homepage') }}produits/{{ produit.slug }}">
              <img
                style="width:75px;"
                class="img-fluid"
                src="{{ asset(produit.image.webPath) }}"
                alt="{{ produit.image.alt }}"
                />
              {{ produit.titre }}
              </div>
            </a>
          </td>
          <td>
            {% if(produit.tva.valeur == 0) %}
              {{ produit.prix }} €
            {% else %}
              {{ produit.prix|ttc(produit.tva) }} € TTC
              <br>
              <small>{{ produit.prix }} € HT</small>
            {% endif %}
          </td>
          <td>
            <input
              name="qte" class="form-control" 
              class="form-control"
              value="{{ panier[produit.id] }}" 
              type="number"
              onChange="this.form.submit()"
              >
          </td>
          <td>
            {% if(produit.tva.valeur == 0) %}
              {{ produit.prix|ttc(produit.tva) * panier[produit.id] }} €
            {% else %}
              {{ produit.prix|ttc(produit.tva) * panier[produit.id] }} € TTC
              <br>
              <small>{{ produit.prix * panier[produit.id] }} € HT</small>
            {% endif %}
          </td>
          <td>
            <a href="{{ path('plateforme_ecommerce_commandeligne_delete', { 'id' : produit.id }) }}">
              <i class="fa fa-trash-o" aria-hidden="true"></i>
            </a>
          </td>
        </form>
        </tr>
        {% set totalTTC = totalTTC + (produit.prix|ttc(produit.tva) * panier[produit.id]) %}
        {% set totalHT = totalHT + (produit.prix * panier[produit.id]) %}
        {% set totalTVAs = totalTVAs|merge({ ( produit.tva.valeur ~ '%') : totalTVAs[produit.tva.valeur ~ '%'] + ( produit.prix * panier[produit.id])|tva(produit.tva) }) %}
      {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="text-right">
            <b>Total HT</b>
          </td>
          <td>{{ totalHT }} € HT</td>
          <td></td>
        </tr>
        {% for key, tva in totalTVAs %}
          {% if tva > 0 %}
            <tr>
              <td colspan="3" class="text-right"><b>TVA {{ key }}</b></td>
              <td>{{ tva }} €</td>
              <td></td>
            </tr>
          {% endif %}
        {% endfor %}
        <tr>
          <td colspan="3" class="text-right">
            <big><b>Total TTC</b></big>
          </td>
          <td>
            <big>{{ totalTTC }} € TTC</big>
          </td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    {% if produits|length != 0 %}
      <hr>
      <a href="{{ path('plateforme_catalogue_produits_index') }}" class="btn btn-primary text-right">
        <i class="fa fa-reply" aria-hidden="true"></i>
        Continuer mes achats
      </a>
    {% endif %}

    {% if produits|length > 0 %}
      <a href="{{ path('plateforme_ecommerce_tunnel_authentification') }}" class="btn btn-success pull-right">
        <i class="fa fa-check" aria-hidden="true"></i>
        Étape suivante
      </a>
    {% endif %}

  </div>
{% endblock %}